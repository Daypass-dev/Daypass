import { Button, Flex, Heading } from "@chakra-ui/react";
import Head from "next/head";
import WalletLayout from "./user/wallet/WalletLayout";
import { useAccount } from "wagmi";
import { getZeroDevSigner, getSocialWalletOwner } from "@zerodevapp/sdk";
import nftArtifact from "../contracts/Hackathon721.sol/Hackathon721.json";

import { GoogleSocialWallet } from "@zerodevapp/social-wallet";
import { useEffect, useState } from "react";
import { Contract, providers } from "ethers";
import { Interface } from "ethers/lib/utils.js";
import { PaymasterAPI } from "@account-abstraction/sdk";
import { UserOperationStruct } from "@account-abstraction/contracts";
import Link from "next/link";

const NFT_CONTRACT_ADDRESS = "0x5a89d913b098c30fcb34f60382dce707177e171e";
const PAYMASTER_ADDRESS = "0x38A310a0D9a015d23B973478c1EF961C3e44Ee62"; // paymaster with whitelisted addresses, latest version
class contractOnlyPaymaster extends PaymasterAPI {
  async getPaymasterAndData(
    userOp: Partial<UserOperationStruct>
  ): Promise<string> {
    return PAYMASTER_ADDRESS;
  }
}

// Gas before on the plain paymaster 1061069010183180134
// 1060664411159720024

export default function Home() {
  const { address, isConnected } = useAccount();
  const [isLoading, setIsLoading] = useState(false);
  const [mintingErrorMessage, setErrorMessage] = useState("");
  const [transactionHash, setTransactionHash] = useState(undefined);
  const mint = async () => {
    setIsLoading(true);
    try {
      console.log("trying to mint..")
      const socialWallet = new GoogleSocialWallet();

      const signer = await getZeroDevSigner({
        projectId: process.env.NEXT_PUBLIC_ZERO_DEV_PROJECT_ID!,
        owner: await getSocialWalletOwner(
          process.env.NEXT_PUBLIC_ZERO_DEV_PROJECT_ID!,
          socialWallet
        ),
      });
      signer.smartAccountAPI.paymasterAPI = new contractOnlyPaymaster();


      const contract = new Contract(
        NFT_CONTRACT_ADDRESS,
        new Interface(nftArtifact.abi),
        signer
      );

      const txn: providers.TransactionResponse = await contract.mint(1);
      setTransactionHash(txn.hash);
      const receipt = await txn.wait();
      setIsLoading(false);
    } catch (e) {
      console.log(e)
      setErrorMessage("Minting Failed. Retry")
      setIsLoading(false);
    }
  };

  useEffect(() => {
    console.log(
      `Hey, the address state is changing here's the new value ${address}`
    );
    setErrorMessage("");

  }, [address]);

  return (
    <>
      <WalletLayout>
        {address && <div> connected! </div>}
        <Flex justifyContent="center" alignItems="stretch" flexDir="column">
          <Head>
            <title>SpaceCAN minting</title>
            <meta name="description" content="Generated by create next app" />
            <link rel="icon" href="/favicon.ico" />
          </Head>
          <Heading>Space Can NFT Collection</Heading>
          <Button onClick={mint} disabled={true}>
            {isLoading ? "Minting in progress..." : (mintingErrorMessage !== "" ? mintingErrorMessage : "Mint NFT")}
          </Button>
          {transactionHash ? <Link href={`https://www.jiffyscan.xyz/userOpHash/${transactionHash}?network=goerli`} passHref>
            <Button as="a">Go to target page</Button>
          </Link> : <></>}

        </Flex>
      </WalletLayout>
    </>
  );
}
